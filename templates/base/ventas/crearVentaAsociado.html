{% load humanize %}

{% load humanize %}

<style>
    /* Asegurar que el dropdown de Select2 en modales funcione correctamente */
    .select2-container {
        z-index: 9999 !important;
    }

    .select2-dropdown {
        z-index: 9999 !important;
    }

    /* Hacer que el modal sea scrollable correctamente con Select2 */
    .modal-body {
        overflow-y: auto;
        max-height: calc(100vh - 120px);
    }

    /* Opci√≥n alternativa: Hacer que el select2 se adapte mejor en modales */
    .select2-container--open .select2-dropdown--below {
        position: fixed !important;
    }
</style>

<div class="modal-dialog modal-xl custom-modal" role="dialog">
    <div class="modal-content">
        <!-- Encabezado -->
        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Registrar Venta</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
            <!-- Datos del asociado -->
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0 text-secondary">Informaci√≥n del Asociado</h6>
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>N¬∞</th>
                                <th>Asociado</th>
                                <th>N¬∞ Documento</th>
                                <th>Tipo Asociado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>{{ asociado.nombre }} {{ query.apellido }}</td>
                                <td>{{ asociado.numDocumento|intcomma }}</td>
                                <td>{{ asociado.tAsociado }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <form action="{% url 'asociado:crearVentaAsociado' pkAsociado %}" method="post">
                {% csrf_token %}

                <!-- Informaci√≥n de la venta -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-secondary">Informaci√≥n de la Venta</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                {{ form.fechaVenta.label_tag }}
                                {{ form.fechaVenta }}
                            </div>
                            <div class="col-12 col-md-6">
                                {{ form.formaPago.label_tag }}
                                {{ form.formaPago }}
                            </div>

                            <!-- M√©todo de pago (solo contado) -->
                            <div class="col-12 col-md-6" id="contenedorMetodoPago" hidden>
                                <label for="id_metodoPago">M√©todo de Pago</label>
                                <select name="metodoPago" class="form-select" id="id_metodoPago" required>
                                    {% for metodo in metodoPago %}
                                        <option value="{{ metodo.id }}">{{ metodo.formaPago }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-12 col-md-6">
                                {{ form.valorBruto.label_tag }}
                                <input type="text" name="valorBruto" class="form-control" id="id_valorBruto" readonly>
                            </div>
                            <div class="col-12 col-md-6">
                                {{ form.valorNeto.label_tag }}
                                {{ form.valorNeto }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n del cr√©dito -->
                <div id="contenedorCredito" class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-secondary">Detalles del Cr√©dito</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-lg-4" id="contenedorTasaInteres">
                                {{ form.tasaInteres.label_tag }}
                                {{ form.tasaInteres }}
                            </div>
                            <div class="col-12 col-lg-4" id="contenedorPrimerMes">
                                <label for="id_primerMes">Primer Mes Cobro</label>
                                <select name="primerMes" class="form-select" id="id_primerMes">
                                    {% for mes in meses %}
                                        <option value="{{ mes.id }}">{{ mes.concepto }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-lg-4" id="contenedorCuotas">
                                {{ form.cuotas.label_tag }}
                                {{ form.cuotas }}
                            </div>

                            <div class="row col-12 mt-3">
                                <div class="col-12 col-lg-4" id="contenedorValorCuotas">
                                    <label for="id_valorCuotas">Valor Cuotas</label>
                                    <input type="text" name="valorCuotas" id="id_valorCuotas" class="form-control" readonly>
                                </div>

                                <div class="col-12 col-lg-4 d-none" id="contenedorAnticipo">
                                    <label for="id_anticipo">Anticipo</label>
                                    <input type="number" name="anticipo" id="id_anticipo" min="0" class="form-control" placeholder="M√≠nimo 15%">
                                </div>

                                <div class="col-12 col-lg-4 d-none" id="contenedorFormaPagoAnticipo">
                                    <label for="id_forma_pago_anticipo">Forma Pago Anticipo</label>
                                    <select name="formaPagoAnticipo" class="form-select" id="id_forma_pago_anticipo">
                                        {% for metodo in metodoPago %}
                                            <option value="{{ metodo.id }}">{{ metodo.formaPago }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de amortizaci√≥n -->
                <div id="contenedorAmortizacion" class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-secondary">Tabla de Amortizaci√≥n</h6>
                        <a type="button" id="calcular" class="btn btn-sm btn-primary">Calcular</a>
                    </div>
                    <div class="card-body">
                        <input id="id_valorCuota" type="hidden" name="valorCuota">
                        <input id="id_totalCredito" type="hidden" name="totalCredito">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="tablaAmortizacion">
                                <thead class="table-light">
                                    <tr>
                                        <th>N¬∞ Cuota</th>
                                        <th>Fecha</th>
                                        <th>Saldo Inicial</th>
                                        <th>Abono Capital</th>
                                        <th>Intereses</th>
                                        <th>Cuota</th>
                                        <th>Saldo Final</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Lista de productos -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-secondary">Lista de Productos</h6>
                        <button id="add-product" type="button" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-circle"></i> Agregar Producto
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="encabezados-container" hidden>
                            <div class="row fw-bold text-secondary mb-2">
                                <div class="col-12 col-md-1 text-center">N¬∞</div>
                                <div class="col-12 col-md-4">Producto</div>
                                <div class="col-12 col-md-1">Precio</div>
                                <div class="col-12 col-md-1">Cantidad</div>
                                <div class="col-12 col-md-2">Total Bruto</div>
                                <div class="col-12 col-md-2">Total Neto</div>
                                <div class="col-12 col-md-1 text-center">Opciones</div>
                            </div>
                        </div>

                        <div id="productos-container"><!-- Contenedor din√°mico JS --></div>

                        <div class="row align-items-center mt-3" id="total-general-container" hidden>
                            <div class="col-12 col-md-7 text-end">
                                <h6 class="fw-bold mb-0">Totales:</h6>
                            </div>
                            <div class="col-12 col-md-2 mb-2">
                                <input type="text" id="id_totales_bruto" class="form-control" placeholder="Total Bruto" readonly>
                            </div>
                            <div class="col-12 col-md-2 mb-2">
                                <input type="text" id="id_totales_neto" class="form-control" placeholder="Total Neto" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n Guardar -->
                <div class="text-end">
                    <button id="submit" type="submit" class="btn btn-success" hidden>Guardar Venta</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$('#creacion').on('shown.bs.modal', function () {

    let today = new Date().toISOString().split('T')[0];  // Obtiene la fecha en formato YYYY-MM-DD
    document.getElementById("id_fechaVenta").value = today;

    const formaPago = document.getElementById('id_formaPago');
    const contenedorMetodoPago = document.getElementById('contenedorMetodoPago');
    const contenedorPrimerMes = document.getElementById('contenedorPrimerMes');
    const contenedorCuotas = document.getElementById('contenedorCuotas');
    const contenedorValorCuotas = document.getElementById('contenedorValorCuotas');
    const contenedorTasaInteres = document.getElementById('contenedorTasaInteres');
    const contenedorAmortizacion = document.getElementById('contenedorAmortizacion');
    const contenedorAnticipo = document.getElementById('contenedorAnticipo');
    const contenedorFormaPagoAnticipo = document.getElementById('contenedorFormaPagoAnticipo');
    
    const tasaInteres = document.getElementById('id_tasaInteres');
    const inputAnticipo = document.getElementById('id_anticipo');
    const encabezado = document.getElementById('encabezados-container');
    const contenedor_totales = document.getElementById('total-general-container');
    const submit = document.getElementById('submit');
    const cuotas = document.getElementById('id_cuotas');
    const container = document.getElementById('productos-container');
    const addButton = document.getElementById('add-product');
    const inputValorBruto = document.getElementById('id_valorBruto');
    const btnCalcular = document.getElementById('calcular');

    let productCount = 0;
    let anticipoMinimo = 0;
    
    // Funcion que cambia los input entre credito y contado
    function toggleCuotas() {
        if (formaPago.value === 'CONTADO') {
            cuotas.disabled = true;
            cuotas.value = 0;
            cuotas.removeAttribute('required');
            tasaInteres.removeAttribute('required');
            contenedorPrimerMes.setAttribute('hidden', 'hidden');
            contenedorTasaInteres.setAttribute('hidden', 'hidden');
            contenedorCuotas.setAttribute('hidden', 'hidden');
            contenedorValorCuotas.setAttribute('hidden', 'hidden');
            contenedorMetodoPago.removeAttribute('hidden');
            contenedorAmortizacion.setAttribute('hidden', 'hidden');
        } else {
            cuotas.disabled = false;
            cuotas.setAttribute('required', 'required');
            contenedorPrimerMes.removeAttribute('hidden');
            contenedorPrimerMes.setAttribute('required', 'required');
            tasaInteres.setAttribute('required', 'required');
            contenedorMetodoPago.setAttribute('hidden', 'hidden');
            contenedorTasaInteres.removeAttribute('hidden');
            contenedorCuotas.removeAttribute('hidden');
            contenedorValorCuotas.removeAttribute('hidden');
            contenedorAmortizacion.removeAttribute('hidden');
        }
        actualizarValorBruto();
        actualizarValorCuotas();
        actualizarValorNeto();
    }


    // funcion para obtener fechaFinal del modelo mesTarifa
    async function obtenerFechaPrimerPago(id_primerMes) {
        const res = await fetch(`/parametro/utils/mes-tarifa-info/${id_primerMes}/`);
        const data = await res.json();
        return data.fechaInicio; // YYYY-MM-DD
    }


    // Evento que calcula la tabla de amortizacion cuando se hace clic en el bot√≥n
    btnCalcular.addEventListener('click', async () => {
        const valorBruto = parseInt(inputValorBruto.value.replace(/\D/g, '')) || 0;

        const [tasaStr, concepto] = tasaInteres.value.split('|');
        const tasa = parseFloat(tasaStr) || 0;
        
        const cuotas = parseInt(document.getElementById('id_cuotas').value) || 0;
        const fechaSolicitud = document.getElementById('id_fechaVenta').value;
        const primerMesPago = document.getElementById("id_primerMes").value;

        if (valorBruto <= 0 || cuotas <= 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Datos incompletos',
                text: 'Por favor, ingresa valores v√°lidos para el valor bruto y las cuotas.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        if (fechaSolicitud === "") {
            Swal.fire({
                icon: 'info',
                title: 'Falta la fecha',
                text: 'Por favor, ingresa la fecha de solicitud.',
                confirmButtonText: 'Ok',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        if (primerMesPago === "") {
            Swal.fire({
                icon: 'info',
                title: 'Falta seleccionar primer mes de cobro',
                text: 'Por favor, seleccione un mes.',
                confirmButtonText: 'Ok',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        const fechaPrimerMes = await obtenerFechaPrimerPago(primerMesPago);

        const selectedText = tasaInteres.options[tasaInteres.selectedIndex].text;
        let saldoInicial = valorBruto;

        // Si es CREDITO PRODUCTO, se descuenta el anticipo
        if (selectedText.includes("CREDITO PRODUCTO")) {
            const anticipo = parseInt(inputAnticipo.value.replace(/\D/g, '')) || 0;
            saldoInicial = valorBruto - anticipo;
        }

        // Generar la tabla de amortizaci√≥n con el saldo ajustado
        generarTablaAmortizacion(saldoInicial, tasa, cuotas, fechaSolicitud, fechaPrimerMes, 1);
    });

    formaPago.addEventListener('change', () => {
        toggleCuotas();
        actualizarTotalConInteresPorProducto();
    });
    
    tasaInteres.addEventListener('change', () => {
        const selectedText = tasaInteres.options[tasaInteres.selectedIndex].text;

        if (selectedText.includes("CREDITO PRODUCTO")) {
            contenedorAnticipo.classList.remove('d-none');
            contenedorFormaPagoAnticipo.classList.remove('d-none')
            calcularAnticipo();
        } else {
            contenedorAnticipo.classList.add('d-none');
            contenedorFormaPagoAnticipo.classList.add('d-none');
            inputAnticipo.value = 0;
        }

        actualizarValorBruto();
        actualizarTotalConInteresPorProducto();
        actualizarValorCuotas();
        actualizarValorNeto();
    });
    
    cuotas.addEventListener('change', () => {
        actualizarValorBruto();
        actualizarTotalConInteresPorProducto();
        actualizarValorCuotas();
        actualizarValorNeto();
    });

    // Si cambia el valor bruto, se recalcula el anticipo autom√°ticamente
    const observerValorBruto = new MutationObserver(() => {
        const selectedText = tasaInteres.options[tasaInteres.selectedIndex].text;
        if (selectedText.includes("CREDITO PRODUCTO")) {
            calcularAnticipo();
        }
    });

    observerValorBruto.observe(inputValorBruto, { attributes: true, attributeFilter: ['value'] });

    // üîπ VALIDACI√ìN DEL ANTICIPO - Solo permite valores >= al m√≠nimo
    inputAnticipo.addEventListener('input', () => {
        let valorIngresado = parseInt(inputAnticipo.value.replace(/\D/g, '')) || 0;
        
        // Si el valor es menor al m√≠nimo, se ajusta al m√≠nimo
        if (valorIngresado < anticipoMinimo && anticipoMinimo > 0) {
            inputAnticipo.value = anticipoMinimo;
        }
    });

    // üîπ CUANDO PIERDE EL FOCO, RECALCULA TODO
    inputAnticipo.addEventListener('blur', () => {
        let valorIngresado = parseInt(inputAnticipo.value.replace(/\D/g, '')) || 0;
        
        // Si el valor es menor al m√≠nimo, se ajusta al m√≠nimo
        if (valorIngresado < anticipoMinimo && anticipoMinimo > 0) {
            inputAnticipo.value = anticipoMinimo;
        }
        
        // Recalcular valores
        actualizarValorCuotas();
        actualizarValorNeto();
    });

    // Funci√≥n para calcular el 15% de anticipo
    function calcularAnticipo() {
        const valorBruto = parseInt(inputValorBruto.value.replace(/\D/g, '')) || 0;
        anticipoMinimo = Math.floor(valorBruto * 0.15);
        
        // Solo actualizar el valor si est√° vac√≠o o es menor al m√≠nimo
        const valorActual = parseInt(inputAnticipo.value.replace(/\D/g, '')) || 0;
        if (valorActual < anticipoMinimo || valorActual === 0) {
            inputAnticipo.value = anticipoMinimo;
        }

        actualizarValorCuotas();
        actualizarValorNeto();
    }

    // Evento que agrega una nueva fila de producto
    addButton.addEventListener('click', () => {
        const newRow = document.createElement('div');
        newRow.classList.add('row', 'producto-item');
        newRow.innerHTML = `
            <div class="col-12 col-xl-1 mb-3 producto-numero">
                <span class="form-control text-center bg-light border-0 fw-bold" readonly></span>
            </div>
            <div class="col-12 col-xl-4 mb-3">
                <select name="producto_${productCount}" class="form-select select2-producto" id="id_producto_${productCount}" required>
                    <option value="">Seleccionar Producto</option>
                    {% for producto in queryProducto %}
                    <option value="{{ producto.id }}" data-precio="{{ producto.precio }}">{{ producto.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-xl-1 mb-3">
                <input type="text" class="form-control" id="id_precio_${productCount}" placeholder="Precio" name="precio_${productCount}" readonly>
            </div>
            <div class="col-12 col-xl-1 mb-3">
                <input type="number" class="form-control" id="id_cantidad_${productCount}" placeholder="Cantidad" name="cantidad_${productCount}" min="0" required>
            </div>
            <div class="col-12 col-xl-2 mb-3">
                <input type="text" class="form-control" id="id_totalBruto_${productCount}" placeholder="Total Bruto" name="totalBruto_${productCount}" readonly>
            </div>
            <div class="col-12 col-xl-2 mb-3">
                <input type="text" class="form-control" id="id_totalConInteres_${productCount}" placeholder="Total Con Interes" name="totalConInteres_${productCount}" readonly>
            </div>
            <div class="col-12 col-xl-1 mb-3">
                <a onclick="eliminarProducto(this)" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-slash-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708"/>
                    </svg>
                </a>
            </div>
        `;
        container.appendChild(newRow);
        renombrarProductos();
        productCount = document.querySelectorAll('.producto-item').length;

        encabezado.removeAttribute('hidden');
        submit.removeAttribute('hidden');
        contenedor_totales.removeAttribute('hidden');

        // Inicializar Select2 en el nuevo select
        const $nuevoSelect = $(newRow).find('.select2-producto');
        if (typeof inicializarSelect2EnModal === 'function') {
            inicializarSelect2EnModal();
        }

        // üî• IMPORTANTE: Agregar el evento select2:select para capturar el cambio
        $nuevoSelect.on('select2:select', function(e) {
            const precioInput = $(this).closest('.producto-item').find('input[name^="precio"]');
            const precio = e.params.data.element.dataset.precio || 0;
            precioInput.val(parseFloat(precio).toLocaleString('es-ES'));
            
            // Actualizar los totales
            actualizarValorBruto();
            actualizarValorCuotas();
            actualizarValorNeto();
        });

        actualizarValorBruto();
        actualizarValorCuotas();
        actualizarValorNeto();
    });


    $(document).on('select2:select', '#productos-container .select2-producto', function(e) {
        const precioInput = $(this).closest('.producto-item').find('input[name^="precio"]');
        const precio = e.params.data.element.dataset.precio || 0;
        precioInput.val(parseFloat(precio).toLocaleString('es-ES'));
        
        actualizarValorBruto();
        actualizarValorCuotas();
        actualizarValorNeto();
    });

    // Evento delegado SOLO para los inputs de cantidad
    container.addEventListener('input', (event) => {
        if (event.target.matches('input[name^="cantidad"]')) {
            const itemRow = event.target.closest('.producto-item');
            const precio = parseFloat(itemRow.querySelector('input[name^="precio"]').value.replace(/\./g, '').replace(',', '.')) || 0;
            const cantidad = parseInt(event.target.value, 10) || 0;
            const totalInput = itemRow.querySelector('input[name^="totalBruto"]');
            const total = precio * cantidad;

            totalInput.value = total.toLocaleString('es-ES');
            
            // Calcular total neto con inter√©s por producto
            const totalConInteresInput = itemRow.querySelector(`input[name^="totalConInteres"]`);

            const [tasaStr, concepto] = tasaInteres.value.split('|');
            const tasa = parseFloat(tasaStr) || 0;
            const cuotasVal = parseInt(cuotas.value);

            if (!isNaN(tasa) && !isNaN(cuotasVal) && cuotasVal > 0) {
                const calcularCuota = (monto, tasa, cuotas) => {
                    if (tasa === 0) return monto;
                    const cuota = Math.round((monto * tasa * Math.pow(1 + tasa, cuotas)) / (Math.pow(1 + tasa, cuotas) - 1));
                    return cuota * cuotas;
                };
                const totalConInteres = calcularCuota(total, tasa, cuotasVal);
                totalConInteresInput.value = totalConInteres.toLocaleString('es-ES');
            } else {
                totalConInteresInput.value = total.toLocaleString('es-ES');
            }
        }

        actualizarValorBruto();
        actualizarValorCuotas();
        actualizarValorNeto();
    });


    // Evento delegado para calcular el total por producto
    container.addEventListener('input', (event) => {
        if (event.target.matches('input[name^="cantidad"]')) {
            const itemRow = event.target.closest('.producto-item');
            const precio = parseFloat(itemRow.querySelector('input[name^="precio"]').value.replace(/\./g, '').replace(',', '.')) || 0;
            const cantidad = parseInt(event.target.value, 10) || 0;
            const totalInput = itemRow.querySelector('input[name^="totalBruto"]');
            const total = precio * cantidad;

            totalInput.value = total.toLocaleString('es-ES');
            
            // Calcular total neto con inter√©s por producto
            const totalConInteresInput = itemRow.querySelector(`input[name^="totalConInteres"]`);

            const [tasaStr, concepto] = tasaInteres.value.split('|');
            const tasa = parseFloat(tasaStr) || 0;
            const cuotasVal = parseInt(cuotas.value);

            if (!isNaN(tasa) && !isNaN(cuotasVal) && cuotasVal > 0) {
                const calcularCuota = (monto, tasa, cuotas) => {
                    if (tasa === 0) return monto;
                    const cuota = Math.round((monto * tasa * Math.pow(1 + tasa, cuotas)) / (Math.pow(1 + tasa, cuotas) - 1));
                    return cuota * cuotas;
                };
                const totalConInteres = calcularCuota(total, tasa, cuotasVal);
                totalConInteresInput.value = totalConInteres.toLocaleString('es-ES');
            } else {
                totalConInteresInput.value = total.toLocaleString('es-ES');
            }
        }
    
        actualizarValorBruto();
        actualizarValorCuotas();
        actualizarValorNeto();
    });


    function actualizarTotalConInteresPorProducto() {
        document.querySelectorAll('.producto-item').forEach(itemRow => {
            const precioInput = itemRow.querySelector('input[name^="precio"]');
            const cantidadInput = itemRow.querySelector('input[name^="cantidad"]');
            const totalInput = itemRow.querySelector('input[name^="totalBruto"]');
            const totalConInteresInput = itemRow.querySelector('input[name^="totalConInteres"]');
    
            const precio = parseFloat(precioInput.value.replace(/\./g, '').replace(',', '.')) || 0;
            const cantidad = parseInt(cantidadInput.value, 10) || 0;
            const total = precio * cantidad;
    
            const [tasaStr, concepto] = tasaInteres.value.split('|');
            const tasa = parseFloat(tasaStr) || 0;
            
            const cuotas = parseInt(document.getElementById("id_cuotas").value);
    
            if (!isNaN(tasa) && !isNaN(cuotas) && cuotas > 0) {
                const calcularCuota = (monto, tasa, cuotas) => {
                    if (tasa === 0) return monto;
                    const cuota = Math.round((monto * tasa * Math.pow(1 + tasa, cuotas)) / (Math.pow(1 + tasa, cuotas) - 1));
                    return cuota * cuotas;
                };
                const totalConInteres = calcularCuota(total, tasa, cuotas);
                totalConInteresInput.value = totalConInteres.toLocaleString('es-ES');
            } else {
                totalConInteresInput.value = total.toLocaleString('es-ES');
            }
        });
    }
    
    // Funci√≥n para calcular el valor total de todos los productos
    function actualizarValorBruto() {
        let totalBruto = 0;

        document.querySelectorAll('.producto-item').forEach(item => {
            const totalNeto = item.querySelector('input[name^="totalBruto"]').value
                .replace(/\./g, '')
                .replace(',', '.');
            totalBruto += parseFloat(totalNeto) || 0;
        });

        const valorBrutoInput = document.querySelector('#id_valorBruto'); 
        valorBrutoInput.value = totalBruto.toLocaleString('es-ES');
        document.getElementById("id_totales_bruto").value = valorBrutoInput.value;

        // üîπ Si est√° seleccionado CREDITO PRODUCTO, recalcular anticipo autom√°ticamente
        const selectedText = tasaInteres.options[tasaInteres.selectedIndex].text;
        if (selectedText.includes("CREDITO PRODUCTO") && totalBruto > 0) {
            calcularAnticipo();
        }
    }

    function actualizarValorCuotas() {
        const valorCuota = document.getElementById("id_valorCuotas");

        const [tasaStr, concepto] = tasaInteres.value.split('|');
        const tasaMensual = parseFloat(tasaStr) || 0;

        const numCuotas = parseInt(document.getElementById("id_cuotas").value, 10);
        const selectedText = tasaInteres.options[tasaInteres.selectedIndex].text;
        const valorBruto = parseInt(inputValorBruto.value.replace(/\D/g, '')) || 0;

        if (isNaN(tasaMensual) || isNaN(numCuotas) || numCuotas <= 0) {
            valorCuota.value = 0;
            return;
        }

        // Obtener el monto base para el c√°lculo
        let montoBase = valorBruto;
        
        // Si es CREDITO PRODUCTO, restar el anticipo del monto base
        if (selectedText.includes("CREDITO PRODUCTO")) {
            const anticipo = parseInt(inputAnticipo.value.replace(/\D/g, '')) || 0;
            montoBase = valorBruto - anticipo;
        }

        if (montoBase <= 0) {
            valorCuota.value = 0;
            return;
        }

        // Calcular el total con inter√©s sobre el monto base (sin anticipo)
        const calcularTotalConInteres = (monto, tasa, cuotas) => {
            if (tasa === 0) return monto;
            const cuota = Math.round((monto * tasa * Math.pow(1 + tasa, cuotas)) / (Math.pow(1 + tasa, cuotas) - 1));
            return cuota * cuotas;
        };

        const totalConInteres = calcularTotalConInteres(montoBase, tasaMensual, numCuotas);
        const cuota = Math.round(totalConInteres / numCuotas);
        
        valorCuota.value = cuota.toLocaleString('es-ES');
    }
    
    function actualizarValorNeto() {
        const formaPago = document.getElementById('id_formaPago').value;
        const selectedText = tasaInteres.options[tasaInteres.selectedIndex].text;
        const valorBruto = parseInt(document.getElementById("id_valorBruto").value.replace(/\D/g, '')) || 0;
        const cuotas = parseInt(document.getElementById("id_cuotas").value) || 0;
        const valorCuota = parseInt(document.getElementById("id_valorCuotas").value.replace(/\D/g, '')) || 0;

        if (formaPago === 'CONTADO') {
            document.getElementById("id_valorNeto").value = valorBruto.toLocaleString('es-ES');
            document.getElementById("id_totales_neto").value = valorBruto.toLocaleString('es-ES');
        } else {
            // Calcular el valor neto como (cuota * n√∫mero de cuotas)
            let valorNeto = valorCuota * cuotas;

            // Si es cr√©dito producto, sumar el anticipo al total
            if (selectedText.includes("CREDITO PRODUCTO")) {
                const anticipo = parseInt(inputAnticipo.value.replace(/\D/g, '')) || 0;
                valorNeto += anticipo;
            }

            document.getElementById("id_valorNeto").value = valorNeto.toLocaleString('es-ES');
            document.getElementById("id_totales_neto").value = valorNeto.toLocaleString('es-ES');
        }
    }

    // Funci√≥n para eliminar una fila de producto
    window.eliminarProducto = function(button) {
        const row = button.closest('.row');
        $(row).find('.select2-producto').select2('destroy');
        row.remove();
        renombrarProductos();
        productCount = document.querySelectorAll('.producto-item').length;
        actualizarValorBruto();
        actualizarValorCuotas();
        actualizarValorNeto();

        if (productCount == 0) {
            submit.setAttribute('hidden', 'hidden');
            encabezado.setAttribute('hidden', 'hidden');
        }
    }       

    function renombrarProductos() {
        const items = document.querySelectorAll('.producto-item');
    
        items.forEach((item, index) => {
            const numeroSpan = item.querySelector('.producto-numero span');
            if (numeroSpan) {
                numeroSpan.textContent = index + 1;
            }

            const productoSelect = item.querySelector('select');
            productoSelect.name = `producto_${index}`;
            productoSelect.id = `id_producto_${index}`;
    
            const precio = item.querySelector('input[name^="precio"]');
            precio.name = `precio_${index}`;
            precio.id = `id_precio_${index}`;
    
            const cantidad = item.querySelector('input[name^="cantidad"]');
            cantidad.name = `cantidad_${index}`;
            cantidad.id = `id_cantidad_${index}`;
    
            const totalBruto = item.querySelector('input[name^="totalBruto"]');
            totalBruto.name = `totalBruto_${index}`;
            totalBruto.id = `id_totalBruto_${index}`;
    
            const totalConInteres = item.querySelector('input[name^="totalConInteres"]');
            totalConInteres.name = `totalConInteres_${index}`;
            totalConInteres.id = `id_totalConInteres_${index}`;
        });
    }
});

</script>