{% extends 'index.html' %}
{% load static %}

{% block extraHead %}
    <style>
        .container {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 500px;
        } 
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 30px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .progress-text {
            font-size: 18px;
            color: #555;
            margin: 10px 0;
        }
        .fase {
            font-size: 16px;
            color: #3498db;
            font-weight: bold;
            margin: 10px 0;
        }
        .error-log {
            margin-top: 20px;
            padding: 10px;
            background: #ffe6e6;
            border-left: 4px solid #ff4444;
            display: none;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
        .error-item {
            font-size: 12px;
            color: #cc0000;
            margin: 5px 0;
        }
    </style>
{% endblock extraHead %}

{% block title %}
    Generar Extractos
{% endblock title %}

{% block contenidoPagina %}

    <div class="container">
        <div class="loader" id="loader"></div>
        <div class="title">Generando Extractos - {{ mes }}</div>
        <div class="fase" id="fase">Fase 1: Obteniendo datos del servidor...</div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="progress-text" id="progressText">Iniciando...</div>
        
        <div class="error-log" id="errorLog">
            <strong>Errores encontrados:</strong>
            <div id="errorList"></div>
        </div>

        <button id="btnIrFormato" class="btn btn-outline-primary d-none mt-3">Ir al formato de extracto</button>

        <button id="btnDescargarTxt" class="btn btn-outline-success d-none mt-3">Descargar Resumen</button>

    </div>
{% endblock contenidoPagina %}

{% block extrajs %}

    <script src="{% static 'js/funcionesFormatos.js' %}"></script>
    <script src="{% static 'js/formatos.js' %}"></script>
    <script src="{% static 'lib/jspdf/1.3.4/jspdf.min.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {

            let extractosDataGlobal = [];

            const mesExtracto = '{{ mesExtracto }}';
            const saldos = '{{ saldos }}' === 'true';
            const urlImagen = "{% static 'img/Formato_ExtractoPago_2025_page_0001.jpg' %}";
            
            // Elementos del DOM
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const fase = document.getElementById('fase');
            const loader = document.getElementById('loader');
            const errorLog = document.getElementById('errorLog');
            const errorList = document.getElementById('errorList');
            
            try {
                // Fase 1: Obtener datos del servidor
                progressText.textContent = 'Conectando con el servidor...';
                
                // Simular progreso mientras espera respuesta
                let progresoSimulado = 0;
                const intervaloSimulado = setInterval(() => {
                    if (progresoSimulado < 90) {
                        progresoSimulado += 2;
                        progressBar.style.width = progresoSimulado + '%';
                        progressBar.textContent = progresoSimulado + '%';
                    }
                }, 500);
                
                // Hacer petición AJAX para obtener extractos
                const formData = new FormData();
                formData.append('mesExtracto', mesExtracto);
                formData.append('saldos', saldos);
                formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
                
                const response = await fetch("{% url 'reportes:obtenerExtractosAPI' %}", {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                extractosDataGlobal = data.extractos;
                
                // Detener simulación
                clearInterval(intervaloSimulado);
                
                if (!data.success) {
                    throw new Error(data.error || 'Error al obtener extractos');
                }
                
                // Completar fase 1
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressText.textContent = `${data.total} extractos obtenidos`;
                
                // Mostrar errores si los hay
                if (data.errores && data.errores.length > 0) {
                    errorLog.style.display = 'block';
                    errorList.innerHTML = data.errores.map(e => 
                        `<div class="error-item">• ${e.nombre}: ${e.error}</div>`
                    ).join('');
                }
                
                // Pequeña pausa para que el usuario vea el 100%
                await sleep(500);
                
                // Fase 2: Generar PDF
                fase.textContent = 'Fase 2: Generando PDF...';
                fase.style.color = '#f39c12';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressText.textContent = 'Preparando documento...';
                
                // Generar PDF con barra de progreso
                await generarPDFExtractoMasivoConProgreso(urlImagen, extractosDataGlobal, {
                    onProgress: (actual, total) => {
                        const porcentaje = Math.round((actual / total) * 100);
                        progressBar.style.width = porcentaje + '%';
                        progressBar.textContent = porcentaje + '%';
                        progressText.textContent = `Generando página ${actual} de ${total}`;
                    }
                });
                
                // Completado
                loader.style.display = 'none';
                fase.textContent = 'Proceso completado exitosamente';
                fase.style.color = '#2ecc71';
                progressBar.style.background = '#2ecc71';
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressText.textContent = 'PDF generado correctamente';
                
                // Redirigir después de 3 segundos
                {% comment %} setTimeout(() => {
                    window.location.replace("{% url 'reportes:formatoExtracto' %}");
                }, 3000); {% endcomment %}

                const btnIrFormato = document.getElementById('btnIrFormato');
                btnIrFormato.classList.remove('d-none');
                btnIrFormato.addEventListener('click', () => {
                    window.location.replace("{% url 'reportes:formatoExtracto' %}");
                });

                const btnGenerarTxt = document.getElementById('btnDescargarTxt');
                btnGenerarTxt.classList.remove('d-none');
                btnGenerarTxt.addEventListener('click', () => {
                    generarTxtMasivo(extractosDataGlobal);
                });
                
            } catch (error) {
                console.error('Error:', error);
                loader.style.display = 'none';
                fase.textContent = 'Error en el proceso';
                fase.style.color = '#e74c3c';
                progressBar.style.background = '#e74c3c';
                progressText.textContent = error.message;
                
                errorLog.style.display = 'block';
                errorList.innerHTML = `<div class="error-item">• ${error.message}</div>`;
            }
        });
        
        /**
        * Genera PDF con callback de progreso
        */
        async function generarPDFExtractoMasivoConProgreso(urlImagen, extractosData, options = {}) {
            const image = await loadImage(urlImagen);
            const pdf = new jsPDF('p', 'pt', 'legal');
            
            const totalExtractos = extractosData.length;
            
            for (let i = 0; i < extractosData.length; i++) {
                const extractoData = extractosData[i];
                
                // Notificar progreso
                if (options.onProgress) {
                    options.onProgress(i + 1, totalExtractos);
                }
                
                // Si no es el primer extracto, agregar nueva página
                if (i > 0) {
                    pdf.addPage('legal', 'portrait');
                }
                
                // Agregar imagen de fondo
                pdf.addImage(image, 'PNG', 0, 0, 613, 1010);
                
                // Generar contenido del extracto
                generarContenidoExtracto(pdf, extractoData);
                
                // Pequeña pausa cada 50 extractos para no bloquear el navegador
                if (i % 50 === 0 && i > 0) {
                    await sleep(10);
                }
            }
            
            // Guardar PDF
            const nombreMes = extractosData[0]?.mes || 'Extractos';
            pdf.save(`Extractos_${nombreMes}_${new Date().getTime()}.pdf`);
            
            console.log('PDF masivo generado exitosamente');
        }
        
        /**
         * Utilidades
         */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>

{% endblock extrajs %}